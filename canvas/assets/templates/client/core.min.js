/*
	The canvas core.

	Author: Robin Saxifrage
	License: Apache 2.0
*/
"use strict";var tk=createToolkit({debug:!1});function CanvasCore(){var t=this;this.palettes=JSON.parse("{{ config.styling.palettes|json(camelize_keys=True) }}"),this.breakpoints=JSON.parse("{{ config.styling.breakpoints|json }}"),this.route=null,this.query={},this.metaPage=null,this.page=null,this.init=tk.init,this.debug=tk.config.debug,this.storage={validators:{regex:function(t,e){t=t.split(":");var n=new RegExp(decodeURIComponent(t[0]),"1"==t[1]?"i":"");return"1"==t[2]!=n.test(e)},range:function(t,e){if(""==e||null==e||void 0==e)return!1;var n=null,i=null;return"null"!=(t=t.split(","))[0]&&(n=parseFloat(t[0])),"null"!=t[1]&&(i=parseFloat(t[1])),(null==n||e>=n)&&(null==i||e<=i)},option:function(t,e){if("any"==t)return""!=e&&null!=e&&void 0!=e}},actions:{redirect:function(t){window.location.href=t.data.url},refresh:function(e){var n=1,i=t.query.refresh;null!=i&&(n=+i+1),window.location.href=window.location.pathname+"?refresh="+n},message:function(e){t.flashMessage=e.data.message}},events:{stopPropagation:function(t,e){e.stopPropagation()},flashMessage:function(e){t.flashMessage=e.attr("cv-message")},submit:function(t){var e=t.parents("form");if(e.empty)throw"No form here";core.form(e.attr("id")).submit()}},form:null,forms:{}},this.plugins={};var e=[];function n(t,e,n){if(void 0===n){var i=tk.functionName(e);"<anonymous function>"!=i?n=i[1]:e.__targetContainer__=t}return t[n]=e,e}this.action=function(t,e){return n(this.storage.actions,t,e)},this.event=function(t,e){return"string"==typeof t?this.storage.events[t]:n(this.storage.events,t,e)},this.validator=function(t,e){return n(this.storage.validators,t,e)},this.plugin=function(t){var n=tk.varg(arguments,1,!0);e.push({constructor:t,condition:n,conditionType:tk.typeCheck(n,"string","function","boolean")})},this.loadPlugins=function(){tk.iter(e,function(e){var n=!1;switch(e.conditionType){case 0:n=t.route==e.condition;break;case 1:n=e.condition();break;case 2:n=e.condition}if(n){var i=new e.constructor;tk.log("Loaded plugin:",i),tk.prop(i,"init")&&i.init(),tk.iter(i,function(t,e){null!=e&&tk.prop(e,"__targetContainer__")&&(e.__targetContainer__[t]=e)}),t.plugins[i.name||tk.functionName(e.constructor)]=i}}),e=[]},tk.inspection(function(e){e.reduce("form").iter(function(e){var n=new function(t){var e=this;this.element=t,this.keys=[],this.content={},this.defaultErrors={},this.required={},this.validators={},this.errors={},this.onSuccess=tk.fn.eatCall,this.submitting=!1,this.success=function(t){this.onSuccess=t},this.validate=function(){var t=tk.varg(arguments,0,null);if(null!=t){var n=tk.varg(arguments,1,this.content[t]),i=this.validators[t],o=null===n&&!(this.required[t]&&this.submitting)||i(n);return this.errors[t]=o?null:this.defaultErrors[t],o}return o=!0,tk.iter(e.keys,function(t){e.validate(t)||(o=!1)}),o},this.submit=function(){if(this.submitting=!0,this.validate()){var n=this.element.children('[type="file"]');if(n.length>0&&0==arguments.length){if(1!=n.length)throw"Only one file upload per form supported";var i=new FileReader,o=tk.unbound(this.content),r=n.ith(0,!1).files[0];return i.onload=function(t){o[n.attr("name")]={data:btoa(t.target.result),mimetype:r.mimetype,name:r.name},e.submit(o)},i.readAsBinaryString(r),void(core.flashMessage="Uploading files...")}o=tk.varg(arguments,0,tk.unbound(this.content));var s=this.element.is("[cv-send-action]")?this.element:this.element.children("[cv-send-action]");s.empty||(o.action=s.attr("cv-send-action"));var a=t.attr("cv-submit-to");core.request("POST",null==a?core.route:a).json(o).success(e.onSuccess).failure(function(t){if("error"!=t.status){var n=tk.prop(t.data,"error_summary",null);e.element.snap("p.error-summary:class(hidden null()):text",n),tk.iter(tk.prop(t.data,"errors",{}),function(t,n){e.errors[t]=n})}else core.flashMessage="An error occurred"}).send()}this.submitting=!1},this.populate=function(t){tk.iter(e.keys,function(n){e.content[n]=tk.prop(t,n,null)})};var n=tk.binding.on(this.content),i=tk.binding.on(this.errors);t.on("submit",function(t,n){e.submit(),n.preventDefault()}).children("[name]").iter(function(t){var o=t.attr("name"),r=t.parents(".field").first(),s=t.attr("cv-error");if(e.keys.push(o),e.content[o]=t.value(),e.defaultErrors[o]=null===s?"Required":decodeURIComponent(s),e.errors[o]=null,e.required[o]=t.is("[required]"),t.is("[cv-validator]")){var a=t.attr("cv-validator"),c=a.indexOf(":"),u=a.substring(0,c);a=a.substring(c+1),e.validators[o]=function(t){return core.storage.validators[u](a,t)}}else e.validators[o]=function(t){return!e.required[o]||null!==t};n(o).changed(function(n){n!=t.value()&&t.value(n),e.validate(o,n)}).begin(),i(o).changed(function(t){r.snap("$e:class(error notnull())>div.error-desc:html",t)}).begin(),t.on({keyup:function(t){e.content[o]=t.value()},change:function(t){e.content[o]=t.value()}})}),tk.log("Created form (at id "+t.attr("id")+"): ",this)}(e);t.storage.forms[e.attr("id")]=n,t.storage.form=t.storage.form||n})}),this.form=function(){return 0==arguments.length?this.storage.form:this.storage.forms[arguments[0]]},this.forms=function(){return this.storage.forms},this.flashMessage=null,tk.init(function(){tk(".flash-message").binding.snap(t,{flashMessage:"$e:class(hidden null()):text...(5000)$e:class(hidden true)"})}),this.tooltip=function(e){var n=e.offset(),i=e.size(),o=tk.varg(arguments,2,e.attr("cv-tooltip")),r=n.x>t.page.size().width/2,s=this.page.ith(0,!1).scrollTop;return t.page.snap("+div.tooltip:class(hidden null()):class(right $r):css(top $t):css(left $l):text",o,{r:r,t:n.y-s-10,l:n.x+i.width/2-10})},tk.inspection(function(e){e.reduce("[cv-tooltip]").iter(function(e){var n=null;e.on({mouseover:function(){n=t.tooltip(e)},mouseout:function(){n.remove()}})})}),this.request=function(){var t=tk.varg.on(arguments);return tk.request(t(0,"POST"),t(1,window.location.href))},tk.request.processor(function(e){e.header("X-Canvas-View-Request","1"),e.fns.success===tk.fn.eatCall&&(e.fns.success=function(t){tk.prop(t,"data")&&tk.prop(t.data,"action")&&core.storage.actions[t.data.action](t)}),e.fns.failure===tk.fn.eatCall&&(e.fns.failure=function(){t.flashMessage="An error occured"})}),this.Modal=function(){this.element=null,this.create=function(){throw"Not implemented."},this.open=function(){this.element=core.page.snap("+div.modal").on("click",this.close).snap("+div.panel").on("click",function(t,e){e.stopPropagation()}).snap("+i.fa.fa-times.closer").on("click",this.close).back().back(),this.create(this.element.snap("div.panel"))},this.close=function(){this.element.remove()}},this.modal=function(t){var e=new t;return e.open(),e},tk.inspection(function(e){e.reduce("[cv-event]").on("click",function(e,n){var i=e.attr("cv-event"),o=tk.prop(t.storage.events,i,null);if(null==o)throw"No such event: "+i;o(e,n)}).back().reduce(".button").classify("open",function(e){return e.attr("href")==t.route}).back().reduce("[cv-action]").on("click",function(t){core.request().json({action:t.attr("cv-action")}).send()})}),tk.init(function(){var e=tk("body");t.route=e.attr("cv-route"),t.page=e.children(".page",!1),t.metaBody=e.children(".meta-body"),tk.iter(window.location.search.substring(1).split("&"),function(e){e=e.split("="),t.query[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}),tk.timeout(t.loadPlugins,250)})}tk.snap.directive("show",function(t,e,n,i){n.classify("hidden",!i(t[0]))}),tk.snap.directive("hide",function(t,e,n,i){n.classify("hidden",i(t[0]))});var core=new CanvasCore;