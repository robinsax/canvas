/*
	# toolkit.js
	
	* DOM inspection and manipulation helpers
	* Live data-DOM mappings
	* AJAX
	
	Author Robin Saxifrage | https://github.com/robinsax/toolkit.js
	
	Licensed under Apache 2.0
*/
function createToolkit(){"use strict";function t(){b.debug&&(console.log.apply(null,arguments),null!=b.logElement)}function e(t,e){switch(u(t,[Array,"object"])){case 0:for(var n=0;n<t.length&&e(t[n],n)!==!1;n++);return;case 1:for(var r in t)if(e(r,t[r])===!1)break;return}}function n(t,e){var n=t.hasOwnProperty(e);return 2==arguments.length?n:n?t[e]:arguments[2]}function r(t,e){setTimeout(t,e)}function s(t,e,n){return t.length>e?arguments.length>3&&arguments[3]&&null==t[e]?n:t[e]:n}function u(t,n){n instanceof Array||(n=[n]);var r=-1;if(e(n,function(e){var e=n[i];if(null==e){if(null==t)return r=i,!1}else{if(typeof t==e)return r=i,!1;try{if(t instanceof e)return r=i,!1}catch(s){}}}),-1==r)throw new TypeError("Incorrect parameter type "+typeof param+" (expected one of "+n+")");return r}function c(t){if("function"==typeof t){var e=[].slice.call(arguments);if(e.splice(0,1),s(arguments,1,!0))for(var n=0;n<e.length;n++)e[n]instanceof Element&&(e[n]=new h(e[n]));return t.apply(null,e)}return t}function h(t){var i=this;this.set=function(){switch(t instanceof h&&(t=t.set.splice()),u(t,[Element,Window,Array,"string"])){case 0:case 1:return[t];case 2:for(var e=0;e<t.length;e++){var n=t[e];n instanceof h&&(t[e]=n.set[0])}return t;case 3:return document.querySelectorAll(t)}}(),this.parent=s(arguments,1,null),this.length=this.set.length,this.empty=0==this.length,this.debug=function(){return console.log(s(arguments,0,"Debug")+":"),console.log(this),this},this.back=function(){if(null==this.parent)throw f("Called back() without parent");return this.parent},this.reverse=function(){var t=this.set.slice();return t.reverse(),new h(t,this)},this.ith=function(t){var e=s(arguments,1,!1);return e?this.set[t]:new h(this.set[t],this)},this.reduce=function(t){u(t,["string","function"]);var e=[],n=s(arguments,1,-1);return this.iter(function(r,i){return r.is(c(t,r,i))&&(e.push(r),n>=0&&e.length==n)?!1:void 0}),new h(e,this)},this.extend=function(t){switch(u(t,[h,Array])){case 0:t=t.set;case 1:var e=[];this.iter(function(t,n){e.push(t)},!1);for(var n=0;n<t.length;n++)e.push(t[n]);return new h(e,this)}},this.parent=function(){return this.parents("*",!1)},this.parents=function(){var t=arguments.length>0?arguments[0]:null,e=arguments.length>1?arguments[1]:!0,n=[];return u(t,[null,"string","function"]),u(e,["boolean"]),e?this.iter(function(e,r){for(var i=e.parentNode;i!==document;)(null==t||i.matches(c(t,e,r)))&&n.push(i),i=i.parentNode},!1):this.iter(function(e,r){var i=e.parentNode;(null==t||i.matches(c(t,e,r)))&&n.push(i)},!1),new h(n,this)},this.children=function(){var t=[],e=arguments.length>0?arguments[0]:"*",n=arguments.length>1?arguments[1]:!0;return n?this.iter(function(n,r){for(var i=n.querySelectorAll(c(e,n,r)),s=0;s<i.length;s++){var u=i[s];-1==t.indexOf(u)&&t.push(u)}},!1):this.iter(function(n,r){for(var i=n.children,s=0;s<i.length;s++){var u=i[s];(null==e||u.matches(c(e,n,r)))&&t.push(u)}},!1),new h(t,this)},this.copy=function(){return new h(this.set[0].cloneNode(!0),this)},this.equals=function(t){switch(u(t,[Element,Array,h])){case 0:return 1==this.length&&this.set[0]==t;case 2:t=t.set;case 1:var n=!1;return e(t,function(t){return-1==this.set.indexOf(t)?(n=!0,!1):void 0}),e(this.set,function(e){return-1==t.indexOf(e)?(n=!0,!1):void 0}),!n&&this.length==t.length}},this.iter=function(t){for(var e=arguments.length>1?arguments[1]:!0,n=0;n<this.set.length;n++){var r=this.set[n];if(e&&(r=new h(r,this)),t(r,n)===!1)break}return this},this.is=function(t){u(t,["string","function"]);for(var e=0;e<this.length;e++){var n=this.set[e];if(!n.matches(c(t,n,e)))return!1}return!0},this.classes=function(){var t=[];return this.iter(function(e){for(var n=e.className.split(/\s+/),r=0;r<n.length;r++){var i=n[r];-1==t.indexOf(i)&&t.push(i)}},!1),t},this.value=function(){if(!(arguments.length>0))return this.set[0].value;arguments[0];this.iter(function(t,e){t.value=val},!1)},this.attr=function(t){switch(u(t,["string","object"])){case 0:if(!(arguments.length>1))return this.set[0].hasAttribute(t)?this.set[0].getAttribute(t):null;var e=t,n=arguments[1];switch(u(n,[null,"string","function"])){case 0:this.iter(function(t,n){t.removeAttribute(e,null)},!1);break;default:this.iter(function(t,r){t.setAttribute(c(e,t,r),c(n,t,r))},!1)}break;case 1:this.iter(function(e,n){for(var r in t)e.setAttribute(r,c(t[r],e,n))},!1)}return this},this.css=function(t){function e(t,e){t=t.replace(/-([a-z])/g,function(t){return t[1].toUpperCase()}),i.iter(function(n,r){n.style[t]=c(e,n,r)},!1)}switch(u(t,["string","object"])){case 0:if(!(arguments.length>1))return window.getComputedStyle(this.set[0]).getPropertyValue(t);e(t,arguments[1]);break;case 1:for(var n in t)e(n,t[n])}return this},this.on=function(t){function e(t,e){i.iter(function(r,i){var s=n(r,"tkEventListeners",null);null==s&&(s=[],r.tkEventListeners=s);var u={event:c(t,r,i),func:function(t){e(new h(r),t,i)}};s.push(u),r.addEventListener(u.event,u.func)},!1)}switch(u(t,["string","object"])){case 0:e(t,arguments[1]);break;case 1:for(var r in t)e(r,t[r])}return this},this.off=function(t){this.iter(function(r){var i=n(r,"tkEventListeners",[]),s=[];e(i,function(e,n){e.event==t&&(r.removeEventListener(e.event,e.func),s.push(n))}),e(s,function(t){i=i.splice(t,1)})},!1)},this.classify=function(t){function e(t,n,s){var u="."+t,o=" "+t;"toggle"==n&&(n=function(t,e){return!t.is(u)}),i.iter(function(i,a){var h=c(n,i,a);if(h)i.is(u)||(i.set[0].className+=o);else if(i.is(u)){var f=i.classes();f.splice(f.indexOf(t),1),i.set[0].className=f.join(" ")}var l=c(s,i,a);l>=0&&r(function(){e(t,!h,-1)},l)})}switch(u(t,["string","object"])){case 0:e(t,s(arguments,1,!0),s(arguments,2,-1));break;case 1:for(var n in t)e(n,t[n])}return this},this.remove=function(){return this.iter(function(t){null!=t.parentNode&&t.parentNode.removeChild(t)},!1),this},this.append=function(t){switch(u(t,[h,Element])){case 0:return t.iter(function(t){t.remove(),i.set[0].appendChild(t.set[0])}),t;case 1:return i.set[0].appendChild(t),new h(t,this)}},this.prepend=function(t){switch(u(t,[h,Element])){case 0:return t.reverse().iter(function(t){t.remove(),i.set[0].insertBefore(t.set[0],i.set[0].firstChild)}).reverse(),t;case 1:return i.set[0].insertBefore(t,this.set[0].firstChild),new h(t,this)}},this.html=function(){if(arguments.length>0){var t=arguments[0];return this.iter(function(e,n){e.innerHTML=c(t,e,n)},!1),this}return this.set[0].innerHTML},this.text=function(){if(arguments.length>0){arguments[0];return this.iter(function(t,e){t.textContent=c(text,t,e)},!1),this}return this.set[0].textContent},this.select=function(){return this.set[0].select(),this},this.offset=function(){for(var t=0,e=0,n=this.set[0];null!=n;)t+=n.offsetLeft,e+=n.offsetTop,n=n.offsetParent;return{x:t,y:e}},this.size=function(){var t=this.set[0],e=t.getBoundingClientRect(),n={width:e.width,height:e.height};if(s(arguments,0,!1)){var r=window.getComputedStyle(t,null);n.width+=r.getPropertyValue("margin-left")+r.getPropertyValue("margin-right"),n.height+=r.getPropertyValue("margin-top")+r.getPropertyValue("margin-bottom"),"border-box"==r.getPropertyValue("box-sizing")&&(n.width+=r.getPropertyValue("padding-left")+r.getPropertyValue("padding-right"),n.height+=r.getPropertyValue("padding-top")+r.getPropertyValue("padding-bottom"))}return n}}function f(t){this.message=t}function l(t){this.message=t}function g(t,r,i){function u(t){function i(e,n){var r=e.attr(n);return null!=r?(t&&e.attr(n,null),r.split(/\s+/g)):[]}r.children("[tk-bind]").iter(function(t,r){var u=i(t,"tk-bind"),o=i(t,"tk-onto"),a=i(t,"tk-view-with"),c=i(t,"tk-callback");e(u,function(e,r){n(g,e)||(g[e]=[]),g[e].push({e:t,onto:s(o,r,"html"),viewWith:s(a,r,"-"),callback:s(c,r,"-")})})})}function o(t){var n=s(arguments,1,c[t]);n instanceof v||e(g[t],function(e,r){if(n instanceof Array)c[t]=new v(n,f[t],e.e,funcs);else{if("-"!=e.viewWith&&(n=funcs[e.viewWith](n)),"html"==e.onto)e.e.html(n);else{if(!e.onto.startsWith("attr"))throw l('Invalid bind tk-onto="'+e.onto+'"');e.e.attr(e.onto.split(":")[1],n)}"-"!=e.callback&&funcs[e.callback](n)}})}var c=this,h=Object.getOwnPropertyNames(t),f={};this.node=r,this.parent=i,this.remove=function(){i.remove(this,!0)},this.extract=function(){var t={};return e(h,function(e,n){var r=this[e];r instanceof v&&(r=r.extract()),t[e]=r}),t};var g={};u(!1),e(g,function(n,r){t[n]instanceof Array&&e(r,function(t){f[n]=t.e.children("*",!1).remove()})}),g={},u(!0),r.children("[tk-src]").on("keyup",function(t){c[t.attr("tk-src")]=t.value()}),r.children("[tk-event]").on(function(t){return t.is("[tk-on]")?t.attr("tk-on"):"click"},function(t,e){funcs[t.attr("tk-event")](c,t,e)}),e(h,function(e){Object.defineProperty(c,a,function(t,e){var n=t;return{get:function(){return n},set:function(t){n instanceof v&&n.remove(),n=t,o(e,n)}}}(t[a],a)),o(a)})}function v(t,n,r,i){function u(t,e){Object.defineProperty(a,""+t,function(){var t=e;return{get:function(){return t},set:function(e){t=new g(o,t.node,a)},configurable:!0}}())}var a=this;this.length=0,this.remap=function(t){for(;this.length>0;)this.remove(0);e(t,function(t){this.push(t)})},this.extract=function(){for(var t=[],e=0;e<this.length;e++){var n=this[e];n instanceof g&&(n=n.extract()),t.push(n)}return t},this.push=function(){e(arguments,function(t){var e=n.copy();u(a.length,new g(t,e,a)),a.length++,r.append(e)})},this.indexOf=function(t){for(var e=0;e<this.length;e++)if(this[e]==t)return e;return-1},this.remove=function(){if(arguments.length>0){var t=arguments[0];s(arguments,1,!1)&&(t=this.indexOf(t)),this[t].node.remove(),delete this[t];for(var e=t+1;e<this.length;e++){var n=this[e];delete this[e],u(e-1,n)}this.length--}else for(;this.length>0;)this.remove(0)},this.remap(t)}function p(){var t=t.on(arguments),n=document.createElement(t(0,"div"));return n.className=t(1,""),n.innerHTML=t(2,""),e(t(3,{}),function(t,e){n.setAttribute(t,e)}),new h(n)}function m(t,n,r,i){var u=s(arguments,4,i),n=n.toUpperCase();(r instanceof g||r instanceof v)&&(r=r.extract());var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4==this.readyState){var t=this.status,e=JSON.parse(this.responseText);(400>t?i:u)(e,t)}};var a=JSON.stringify(r);if("GET"==n)t+="?",e(r,function(e,n){t+=e+"="+encodeURIComponent(n)}),o.open(n,t,!0);else{if("POST"!=n)throw"Unsupported method "+n;o.open("POST",t,!0),o.setRequestHeader("Content-Type","application/json")}e(E,function(t){a=t(o,a)}),o.send(a)}function d(t,e,n){var r=typeof t;if("string"==r||"number"==r||"boolean"==r)return t;var i=!(t instanceof Array);i&&(t=[t]);var s=arguments.length>3?arguments[3]:{},u=new v(t,C[e],n,s);return i?u[0]:u}function w(t){return O.push(t),A}function y(){var t=A(b.templateContainer).remove();t.children("[tk-template]",!1).iter(function(t){C[t.attr("tk-template")]=t});e(O,function(t){t()})}Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector);var b={templateContainer:".tk-templates",debug:!1,logElement:null};if(arguments.length>0){var k=arguments[1];for(var x in k)b[x]=k[x]}t.millis=function(){var t=new Date;return t.getTime()},s.on=function(t){return function(e,n){return s(t,e,n)}};var E=[];m.processor=function(t){return E.push(t),A};var C={},O=[],A=function(t){return new h(t)};return A.config=b,A.debug=t,A.varg=s,A.defer=r,A.iter=e,A.e=p,A.request=m,A.mapping=d,A.init=w,A.types={ToolkitInstance:h,MappedObject:g,MappedArray:v,ChainingError:f},/complete|loaded|interactive/.test(document.readyState)?y():window.addEventListener("DOMContentLoaded",y),A}