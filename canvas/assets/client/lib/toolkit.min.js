/*
	# toolkit.js
	
	* DOM inspection and manipulation helpers
	* Live data-DOM mappings
	* AJAX
	
	Author Robin Saxifrage | https://github.com/robinsax/toolkit.js
	
	Licensed under Apache 2.0
*/
function createToolkit(){"use strict";function makeDefault(t){return config.dataPrefix+"-"+t}function debug(){config.debug&&console.log.apply(null,arguments)}function iter(t,e){switch(typeCheck(t,[MappedArray,Array,"object","number"])){case 0:case 1:for(var n=0;n<t.length&&e(t[n],n)!==!1;n++);return;case 2:for(var r in t)if(e(r,t[r])===!1)break;return;case 3:for(var n=0;t>n&&e(n)!==!1;n++);return}}function comprehension(t,e){typeCheck(t,[Array,MappedArray]);for(var n=[],r=0;r<t.length;r++){var i=e(t[r],r);void 0!==i&&n.push(i)}return n}function prop(t,e){var n=t.hasOwnProperty(e);return 2==arguments.length?n:n?t[e]:arguments[2]}function defer(t,e){setTimeout(t,e),varg(arguments,2,!1)&&t()}function repeat(t,e){var n=setInterval(t,e);return varg(arguments,2,!1)&&t(),{stop:function(){clearInterval(n)}}}function varg(t,e,n){return t.length>e?arguments.length>3&&arguments[3]&&null==t[e]?n:t[e]:n}function typeCheck(t,e){e instanceof Array||(e=[e]);for(var n=-1,r=0;r<e.length;r++){var i=e[r];if(null==i){if(null==t){n=r;break}}else{if(typeof t==i){n=r;break}try{if(t instanceof i){n=r;break}}catch(s){}}}if(-1==n)throw new TypeError("Incorrect parameter type "+typeof param+" (expected one of "+e+")");return n}function resolve(t){if("function"==typeof t){var e=[].slice.call(arguments);if(e.splice(0,1),varg(arguments,1,!0))for(var n=0;n<e.length;n++)e[n]instanceof Element&&(e[n]=new ToolkitInstance(e[n]));return t.apply(null,e)}return t}function ToolkitInstance(t){var e=this;this.set=function(){switch(t instanceof ToolkitInstance&&(t=t.set.splice()),typeCheck(t,[Element,Window,Array,"string"])){case 0:case 1:return[t];case 2:for(var e=0;e<t.length;e++){var n=t[e];n instanceof ToolkitInstance&&(t[e]=n.set[0])}return t;case 3:return document.querySelectorAll(t)}}(),this.backP=varg(arguments,1,null),this.length=this.set.length,this.empty=0==this.length,this.debug=function(){return console.log(varg(arguments,0,"Debug")+":",this),this},this.back=function(){if(null==this.backP)throw new ChainingError("Called back() without parent");return this.backP},this.reverse=function(){var t=this.set.slice();return t.reverse(),new ToolkitInstance(t,this)},this.ith=function(t){var e=varg(arguments,1,!1);return e?this.set[t]:new ToolkitInstance(this.set[t],this)},this.reduce=function(t){typeCheck(t,["string","function"]);var e=[],n=varg(arguments,1,-1);return this.iter(function(r,i){return r.is(resolve(t,r,i))&&(e.push(r),n>=0&&e.length==n)?!1:void 0}),new ToolkitInstance(e,this)},this.extend=function(t){switch(typeCheck(t,[ToolkitInstance,Array])){case 0:t=t.set;case 1:var e=[];this.iter(function(t,n){e.push(t)},!1);for(var n=0;n<t.length;n++)e.push(t[n]);return new ToolkitInstance(e,this)}},this.parent=function(){return this.parents("*",!1)},this.parents=function(){var t=arguments.length>0?arguments[0]:null,e=arguments.length>1?arguments[1]:!0,n=[];return typeCheck(t,[null,"string","function"]),typeCheck(e,["boolean"]),e?this.iter(function(e,r){for(var i=e.parentNode;i!==document;)(null==t||i.matches(resolve(t,e,r)))&&n.push(i),i=i.parentNode},!1):this.iter(function(e,r){var i=e.parentNode;(null==t||i.matches(resolve(t,e,r)))&&n.push(i)},!1),new ToolkitInstance(n,this)},this.children=function(){var t=[],e=arguments.length>0?arguments[0]:"*",n=arguments.length>1?arguments[1]:!0;return n?this.iter(function(n,r){for(var i=n.querySelectorAll(resolve(e,n,r)),s=0;s<i.length;s++){var a=i[s];-1==t.indexOf(a)&&t.push(a)}},!1):this.iter(function(n,r){for(var i=n.children,s=0;s<i.length;s++){var a=i[s];(null==e||a.matches(resolve(e,n,r)))&&t.push(a)}},!1),new ToolkitInstance(t,this)},this.copy=function(){return new ToolkitInstance(this.set[0].cloneNode(!0),this)},this.equals=function(t){switch(typeCheck(t,[Element,Array,ToolkitInstance])){case 0:return 1==e.length&&e.set[0]==t;case 2:t=t.set;case 1:var n=!1;return iter(t,function(t){return-1==e.set.indexOf(t)?(n=!0,!1):void 0}),iter(e.set,function(e){return-1==t.indexOf(e)?(n=!0,!1):void 0}),!n&&e.length==t.length}},this.iter=function(t){for(var e=varg(arguments,1,!0),n=0;n<this.set.length;n++){var r=this.set[n];if(e&&(r=new ToolkitInstance(r,this)),t(r,n)===!1)break}return this},this.comprehension=function(t){for(var e=varg(arguments,1,!0),n=[],r=0;r<this.set.length;r++){var i=this.set[r];e&&(i=new ToolkitInstance(i,this));var s=t(i,r);void 0!==s&&n.push(s)}return n},this.is=function(t){typeCheck(t,["string","function"]);for(var e=0;e<this.length;e++){var n=this.set[e];if(!n.matches(resolve(t,n,e)))return!1}return!0},this.classes=function(){var t=[];return this.iter(function(e){for(var n=e.className.split(/\s+/),r=0;r<n.length;r++){var i=n[r];-1==t.indexOf(i)&&t.push(i)}},!1),t},this.value=function(){if(arguments.length>0){var t=arguments[0];return this.iter(function(e,n){e.value=t},!1),this}return"checkbox"==this.set[0].type?this.set[0].checked:this.set[0].value},this.attr=function(t){switch(typeCheck(t,["string","object"])){case 0:if(!(arguments.length>1))return this.set[0].hasAttribute(t)?this.set[0].getAttribute(t):null;var e=t,n=arguments[1];switch(typeCheck(n,[null,"string","function"])){case 0:this.iter(function(t,n){t.removeAttribute(e,null)},!1);break;default:this.iter(function(t,r){t.setAttribute(resolve(e,t,r),resolve(n,t,r))},!1)}break;case 1:this.iter(function(e,n){for(var r in t)e.setAttribute(r,resolve(t[r],e,n))},!1)}return this},this.css=function(t){function n(t,n){t=t.replace(/-([a-z])/g,function(t){return t[1].toUpperCase()}),e.iter(function(e,r){e.style[t]=resolve(n,e,r)},!1)}switch(typeCheck(t,["string","object"])){case 0:if(!(arguments.length>1))return window.getComputedStyle(this.set[0]).getPropertyValue(t);n(t,arguments[1]);break;case 1:for(var r in t)n(r,t[r])}return this},this.on=function(t){function n(t,n){e.iter(function(e,r){var i=prop(e,"tkEventListeners",null);null==i&&(i=[],e.tkEventListeners=i);var s={event:resolve(t,e,r),func:function(t){n(new ToolkitInstance(e),t,r)}};i.push(s),e.addEventListener(s.event,s.func)},!1)}switch(typeCheck(t,["function","string","object"])){case 0:case 1:n(t,arguments[1]);break;case 2:for(var r in t)n(r,t[r])}return this},this.off=function(t){return this.iter(function(e){var n=prop(e,"tkEventListeners",[]),r=[];iter(n,function(n,i){n.event==t&&(e.removeEventListener(n.event,n.func),r.push(i))}),iter(r,function(t){n=n.splice(t,1)})},!1),this},this.classify=function(t){function n(t,r,i){var s="."+t,a=" "+t;"toggle"==r&&(r=function(t,e){return!t.is(s)}),e.iter(function(e,o){var u=resolve(r,e,o);if(u)e.is(s)||(e.set[0].className+=a);else if(e.is(s)){var c=e.classes();c.splice(c.indexOf(t),1),e.set[0].className=c.join(" ")}var l=resolve(i,e,o);l>=0&&defer(function(){n(t,!u,-1)},l)})}switch(typeCheck(t,["string","object"])){case 0:n(t,varg(arguments,1,!0),varg(arguments,2,-1));break;case 1:for(var r in t)n(r,t[r])}return this},this.remove=function(){return this.iter(function(t){null!=t.parentNode&&t.parentNode.removeChild(t)},!1),this},this.append=function(t){switch(typeCheck(t,[Array,ToolkitInstance,Element])){case 0:var n=[];return iter(t,function(t){var r=e.append(t);r.iter(function(t){n.push(t.set[0])})}),new ToolkitInstance(n,this);case 1:return t.iter(function(t){t.remove(),e.set[0].appendChild(t.set[0]),config.bindFunction(t)}),t.backP=this,t;case 2:return e.set[0].appendChild(t),config.bindFunction(t),new ToolkitInstance(t,this)}},this.prepend=function(t){switch(typeCheck(t,[Array,ToolkitInstance,Element])){case 0:var n=[];return t=t.splice(0).reverse(),iter(t,function(t){var r=e.prepend(t);r.iter(function(t){n.push(t.set[0])})}),new ToolkitInstance(n,this);case 1:return t.reverse().iter(function(t){t.remove(),e.set[0].insertBefore(t.set[0],e.set[0].firstChild),config.bindFunction(t)}),t.backP=this,t;case 2:return e.set[0].insertBefore(t,this.set[0].firstChild),config.bindFunction(t),new ToolkitInstance(t,this)}},this.tag=function(){return this.set[0].tagName},this.next=function(){var t=this.set[0].nextElementSibling;return null==t&&(t=[]),new ToolkitInstance(t,this)},this.prev=function(){var t=this.set[0].previousElementSibling;return null==t&&(t=[]),new ToolkitInstance(t,this)},this.html=function(){if(arguments.length>0){var t=arguments[0];return this.iter(function(e,n){e.innerHTML=resolve(t,e,n)},!1),this}return this.set[0].innerHTML},this.text=function(){if(arguments.length>0){var t=arguments[0];return this.iter(function(e,n){e.textContent=resolve(t,e,n)},!1),this}return this.set[0].textContent},this.select=function(){return this.set[0].select(),this},this.offset=function(){for(var t=0,e=0,n=this.set[0];null!=n;)t+=n.offsetLeft,e+=n.offsetTop,n=n.offsetParent;return{x:t,y:e}},this.size=function(){var t=this.set[0],e=t.getBoundingClientRect(),n={width:e.width,height:e.height};if(varg(arguments,0,!1)){var r=window.getComputedStyle(t,null);n.width+=r.getPropertyValue("margin-left")+r.getPropertyValue("margin-right"),n.height+=r.getPropertyValue("margin-top")+r.getPropertyValue("margin-bottom"),"border-box"==r.getPropertyValue("box-sizing")&&(n.width+=r.getPropertyValue("padding-left")+r.getPropertyValue("padding-right"),n.height+=r.getPropertyValue("padding-top")+r.getPropertyValue("padding-bottom"))}return n}}function ChainingError(t){this.message=t}function BindParameterError(t){this.message=t}function MappedObject(obj,node,parent){function parseBindings(t){function e(e,n){var r=e.attr(n);if(null!=r){t&&e.attr(n,null);var i=r.match(/(?:(?:<.*?>)|[^\s]+)(?:\s+|$)/g);return iter(i,function(t,e){0==t.indexOf("<")&&(t=t.substring(1,t.length-1)),i[e]=t.trim()}),i}return[]}node.children("["+attrNames.bind+"]").iter(function(t,n){var r=e(t,attrNames.bind),i=e(t,attrNames.onto),s=e(t,attrNames.viewFn),a=e(t,attrNames.callback);iter(r,function(e,n){prop(bindings,e)||(bindings[e]=[]),bindings[e].push({e:t,onto:varg(i,n,"html"),viewWith:varg(s,n,"-"),callback:varg(a,n,"-")})})})}function applyBind(p){var value=varg(arguments,1,self[p]);if(!(value instanceof MappedArray)){var bound=tk.prop(bindings,p,null);null!=bound&&iter(bound,function(b,i){if(value instanceof Array)self[p]=new MappedArray(value,subtemplates[p],b.e,funcs);else{var asViewed=value;if("-"!=b.viewWith)if(b.viewWith.indexOf("lambda:")>-1){var v=value;asViewed=eval("(function(){ return "+b.viewWith.substring(7)+" })();")}else asViewed=funcs[b.viewWith](value,p);if("html"==b.onto)b.e.html(asViewed);else{if(!(b.onto.indexOf("attr:")>-1))throw new BindParameterError("Invalid bind "+attrNames.bind+'="'+b.onto+'"');b.e.attr(b.onto.substring(5),asViewed)}"-"!=b.callback&&funcs[b.callback](asViewed)}})}}var self=this,funcs=parent._funcs,props=Object.getOwnPropertyNames(obj),subtemplates={};this.node=node,this.remove=function(){parent.remove(this,!0)},this.extract=function(){var t={};return iter(props,function(e,n){var r=self[e];r instanceof MappedArray&&(r=r.extract()),t[e]=r}),t},this.remap=function(t){return parent.remap([t]),parent[0]};var bindings={};parseBindings(!1),iter(bindings,function(t,e){obj[t]instanceof Array&&iter(e,function(e){subtemplates[t]=e.e.children("*",!1).remove()})}),bindings={},parseBindings(!0),node.children("["+attrNames.src+"]").on("keyup",function(t){self[t.attr(attrNames.src)]=t.value()}),node.children("["+attrNames.event+"]").on(function(t){return t.is("["+attrNames.on+"]")?t.attr(attrNames.on):"click"},function(t,e){funcs[t.attr(attrNames.event)](self,t,e)}),iter(props,function(t){Object.defineProperty(self,t,function(t,e){var n=t;return{get:function(){return n},set:function(t){n instanceof MappedArray&&n.remove(),n=t,applyBind(e,n)}}}(obj[t],t)),applyBind(t)})}function MappedArray(t,e,n,r){function i(t,e){Object.defineProperty(s,""+t,function(){var t=e;return{get:function(){return t},set:function(e){t=new MappedObject(o,t.node,s)},configurable:!0}}())}var s=this;iter(config.globalTemplateFunctions,function(t,e){null==prop(r,t,null)&&(r[t]=e)}),this.length=0,this._funcs=r,this.remap=function(t){for(;this.length>0;)this.remove(0);iter(t,function(t){s.push(t)})},this.extract=function(){for(var t=[],e=0;e<this.length;e++){var n=this[e];n instanceof MappedObject&&(n=n.extract()),t.push(n)}return t},this.push=function(){for(var t=0;t<arguments.length;t++){var r=arguments[t],a=e.copy().attr("tk-template",null);i(s.length,new MappedObject(r,a,s)),s.length++,n.append(a)}},this.indexOf=function(t){for(var e=0;e<this.length;e++)if(this[e]==t)return e;return-1},this.remove=function(){if(arguments.length>0){var t=arguments[0];varg(arguments,1,!1)&&(t=this.indexOf(t)),this[t].node.remove(),delete this[t];for(var e=t+1;e<this.length;e++){var n=this[e];delete this[e],i(e-1,n)}this.length--}else for(;this.length>0;)this.remove(0)},this.remap(t)}function createElement(){var t=varg.on(arguments),e=document.createElement(t(0,"div"));return e.className=t(1,"",!0),e.innerHTML=t(2,"",!0),iter(t(3,{}),function(t,n){e.setAttribute(t,n)}),new ToolkitInstance(e)}function request(t,e,n,r){var i=varg(arguments,4,r),e=e.toUpperCase();(n instanceof MappedObject||n instanceof MappedArray)&&(n=n.extract());var s=new XMLHttpRequest;s.onreadystatechange=function(){if(4==this.readyState){var t=this.status,e=JSON.parse(this.responseText);(400>t?r:i)(e,t)}};var a;if("GET"==e)t+="?",iter(n,function(e,n){t+=e+"="+encodeURIComponent(n)}),s.open(e,t,!0),a="";else{if("POST"!=e)throw"Unsupported method "+e;s.open("POST",t,!0),s.setRequestHeader("Content-Type","application/json"),a=JSON.stringify(n)}iter(processors,function(t){t(s,a)}),s.send(a)}function map(t,e,n){var r=typeof t;if("string"==r||"number"==r||"boolean"==r)return t;var i=!(t instanceof Array);i&&(t=[t]);var s=new MappedArray(t,templates[e],n,varg(arguments,3,{}));return i?s[0]:s}function init(t){return initFns.push(t),tk}function doInit(){var t=tk(config.templateContainer).remove();t.children("["+attrNames.template+"]",!1).iter(function(t){templates[t.attr(attrNames.template)]=t}).attr(attrNames.template,null),debug("Loaded templates:",templates),iter(initFns,function(t){t()})}if(Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector),!Window)var Window=function(){};var config={templateContainer:".tk-templates",dataPrefix:"tk",globalTemplateFunctions:{},bindFunction:function(){},debug:!1};if(arguments.length>0){var ovr=arguments[0];for(var entry in ovr)config[entry]=ovr[entry]}var attrNames={bind:makeDefault("bind"),onto:makeDefault("onto"),viewFn:makeDefault("view-fn"),src:makeDefault("src"),callback:makeDefault("callback"),event:makeDefault("event"),on:makeDefault("on"),template:makeDefault("template")};debug.millis=function(){var t=new Date;return t.getTime()},prop.on=function(t){return function(e){return 2==arguments.length?prop(t,e,arguments[1]):prop(t,e)}},varg.on=function(t){return function(e,n){return varg(t,e,n,varg(arguments,2,!1))}};var processors=[];request.processor=function(t){return processors.push(t),tk};var templates={},initFns=[],tk=function(t){return new ToolkitInstance(t)};return tk.config=config,tk.prop=prop,tk.debug=debug,tk.varg=varg,tk.defer=defer,tk.repeat=repeat,tk.iter=iter,tk.comprehension=comprehension,tk.e=createElement,tk.request=request,tk.map=map,tk.templates=templates,tk.init=init,tk.typeCheck=typeCheck,tk.attrNames=attrNames,tk.types={ToolkitInstance:ToolkitInstance,MappedObject:MappedObject,MappedArray:MappedArray,ChainingError:ChainingError},/complete|loaded|interactive/.test(document.readyState)?doInit():window&&window.addEventListener("DOMContentLoaded",doInit),tk}
