/*
	toolkit.js

	Author: Robin Saxifrage
	License: Apache 2.0
*/
"use strict";function createToolkit(){var t=new Object,e=function(t){return new n(t)};function n(t){var i=this;this.backChain=e.varg(arguments,1,null),this.set=function(){switch(t instanceof n&&(t=t.set.splice()),e.typeCheck(t,Element,Window,NodeList,Array,"string")){case 0:case 1:return[t];case 2:case 3:for(var i=[],r=0;r<t.length;r++){var s=t[r];s instanceof n?i=i.concat(s.set):i.push(s)}return i;case 4:return e.config.documentRoot.querySelectorAll(t)}}(),this.length=this.set.length,this.empty=0==this.length,this.back=function(){if(null==this.backChain)throw"Illegal back()";return this.backChain},this.ith=function(t){if(t<0||t>=this.length)throw"Out of bounds: "+t;return e.varg(arguments,1,!0)?new n(this.set[t],this):this.set[t]},this.reversed=function(){var t=this.set.slice();return t.reverse(),new n(t,this)},this.reduce=function(t){switch(e.typeCheck(t,"string","function")){case 0:this.comprehension(function(e){if(e.is(t))return e});break;case 1:this.comprehension(t)}return new n(function(){},this)},this.extend=function(t){switch(e.typeCheck(t,n,Array)){case 0:return new n(this.set.concat(t.set),this);case 1:for(var i=[],r=0;r<t.length;r++){var s=t[r];s instanceof n?i=i.concat(s.set):i.push(s)}return new n(this.set.concat(t),this)}},this.parents=function(){if(1==arguments.length&&"boolean"==typeof arguments[0])return this.parents("*",arguments[0]);var t=e.varg.on(arguments),i=t(0,"*"),r=t(1,!0),s=e.typeCheck(i,"string","function");e.typeCheck(r,"boolean");var o=[];return this.iter(function(t,n){for(var a,c,h=t.parentNode;h!=e.config.documentRoot;){if(a=h,c=n,(0==s&&a.matches(i)||1==s&&i(a,c))&&o.push(h),!r)return;h=h.parentNode}},!1),new n(o,this)},this.children=function(){if(1==arguments.length&&"boolean"==typeof arguments[0])return this.children("*",arguments[0]);var t=e.varg.on(arguments),i=t(0,"*"),r=t(1,!0),s=e.typeCheck(i,"string","function");e.typeCheck(r,"boolean");var o=[];return this.iter(function(t,a){var c=function(t,o){if(0==s)return r?t.querySelectorAll(i):t.children;var a=r?t.querySelectorAll("*"):t.children;return e.comprehension(a,function(t){if(i(new n(t),o))return t})}(t,a);for(a=0;a<c.length;a++)o.push(c[a])},!1),new n(o,this)},this.copy=function(){return new n(this.set[0].cloneNode(!0),this)},this.equals=function(t){switch(e.typeCheck(t,Element,Array,n)){case 0:return 1==i.length&&i.set[0]==t;case 2:t=t.set;case 1:var r=!1;return iter(t,function(t){if(-1==i.set.indexOf(t))return r=!0,!1}),iter(i.set,function(e){if(-1==t.indexOf(e))return r=!0,!1}),!r&&i.length==t.length}},this.iter=function(t){for(var i=e.varg(arguments,1,!0),r=0;r<this.set.length;r++){var s=this.set[r];if(i&&(s=new n(s,this)),!1===t(s,r))break}return this},this.comprehension=function(t){for(var i=e.varg(arguments,1,!0),r=[],s=0;s<this.set.length;s++){var o=this.set[s];i&&(o=new n(o,this));var a=t(o,s);void 0!==a&&r.push(a)}return r},this.is=function(t){for(var n=e.typeCheck(t,"string","function"),i=0;i<this.length;i++){var r=this.set[i];if(0==n){if(!r.matches(t))return!1}else if(!t(new ToolkitInstance(r),i))return!1}return!0},this.classes=function(){var t=[];return this.iter(function(e){for(var n=e.className.split(/\s+/),i=0;i<n.length;i++){var r=n[i];-1==t.indexOf(r)&&t.push(r)}},!1),t},this.value=function(){if(arguments.length>0){var t=arguments[0];return this.iter(function(e){e.value=t},!1),this}return"checkbox"==this.set[0].type?this.set[0].checked:this.set[0].value},this.attr=function(t){switch(e.typeCheck(t,"string","object")){case 0:if(!(arguments.length>1))return this.set[0].hasAttribute(t)?this.set[0].getAttribute(t):null;var n=t,i=arguments[1];switch(e.typeCheck(i,null,"string","function")){case 0:this.iter(function(t,e){t.removeAttribute(n,null)},!1);break;default:this.iter(function(t,r){t.setAttribute(n,e.resolve(i,t,r))},!1)}break;case 1:this.iter(function(n,i){for(var r in t)n.setAttribute(r,e.resolve(t[r],n,i))},!1)}return this},this.css=function(t){function n(t,n){t=t.replace(/-([a-z])/g,function(t){return t[1].toUpperCase()}),i.iter(function(i,r){var s=e.resolve(n,i,r);"number"==typeof s&&(s+="px"),i.style[t]=s},!1)}switch(e.typeCheck(t,"string","object")){case 0:if(!(arguments.length>1))return window.getComputedStyle(this.set[0]).getPropertyValue(t);n(t,arguments[1]);break;case 1:for(var r in t)n(r,t[r])}return this},this.on=function(t){function r(t,r){i.iter(function(i,s){e.prop(i,"__listeners__")||(i.__listeners__=[]);var o={event:e.resolve(t,i,s),func:function(t){r(new n(i),t,s)}};i.__listeners__.push(o),i.addEventListener(o.event,o.func)},!1)}switch(e.typeCheck(t,"string","object")){case 0:r(t,arguments[1]);break;case 1:for(var s in t)r(s,t[s])}return this},this.off=function(t){return this.iter(function(n){var i=e.prop(n,"__listeners__",[]),r=[];e.iter(i,function(e,i){e.event==t&&(n.removeEventListener(e.event,e.func),r.push(i))}),e.iter(r,function(t){i=i.splice(t,1)})},!1),this},this.classify=function(t){function n(t,r,s){var o="."+t;"toggle"==r&&(f=function(t,e){return!t.is(o)}),i.iter(function(i,a){var c=e.resolve(r,i,a),h=i.classes();c?i.is(o)||(h.push(t),i.set[0].className=h.join(" ").trim()):i.is(o)&&(h.splice(h.indexOf(t),1),i.set[0].className=h.join(" ").trim());var u=e.resolve(s,i,a);u>=0&&e.defer(function(){n(t,!c,-1)},u)})}switch(e.typeCheck(t,"string","object")){case 0:var r=e.varg.on(arguments);n(t,r(1,!0),r(2,-1));break;case 1:e.iter(t,n)}return this},this.remove=function(){return this.iter(function(t){null!=t.parentNode&&t.parentNode.removeChild(t)},!1),this},this.append=function(t){switch(e.typeCheck(t,Array,n,Element)){case 0:var r=[];return e.iter(t,function(t,e){t instanceof n?(t.remove(),r=r.concat(t.set)):(t.parentNode.removeChild(t),r.push(t))}),e.iter(r,function(t){e.config.callbacks.preInsert(new n(t)),i.set[0].appendChild(t)}),new n(r,this);case 1:return t.iter(function(t){t.remove(),i.set[0].appendChild(t.set[0]),e.config.callbacks.preInsert(t)}),t.origin=this,t;case 2:return i.set[0].appendChild(t),e.config.callbacks.preInsert(t),new n(t,this)}},this.prepend=function(t){switch(typeCheck(t,Array,n,Element)){case 0:var r=[];return e.iter(arg,function(t,e){t instanceof n?(t.remove(),r=r.concat(t.set)):(t.parentNode.removeChild(t),r.push(t))}),e.iter(r,function(t){e.config.callbacks.preInsert(new n(t)),i.set[0].insertBefore(t,i.set[0].firstChild)}),new n(r,this);case 1:return t.reverse().iter(function(t){t.remove(),i.set[0].insertBefore(t.set[0],i.set[0].firstChild),config.config.callbacks.preInsert(t)}),t.origin=this,t;case 2:return i.set[0].insertBefore(t,this.set[0].firstChild),config.callbacks.preInsert(t),new n(t,this)}},this.tag=function(){return this.set[0].tagName},this.next=function(){var t=this.set[0].nextElementSibling;return null==t&&(t=[]),new n(t,this)},this.prev=function(){var t=this.set[0].previousElementSibling;return null==t&&(t=[]),new n(t,this)},this.html=function(){if(arguments.length>0){var t=arguments[0];return this.iter(function(i,r){i.innerHTML=e.resolve(t,new n(i),r)},!1),this}return this.set[0].innerHTML},this.text=function(){if(arguments.length>0){var t=arguments[0];return this.iter(function(i,r){i.textContent=e.resolve(t,new n(i),r)},!1),this}return this.set[0].textContent},this.select=function(){return this.set[0].select(),this},this.offset=function(){for(var t=0,e=0,n=this.set[0];null!=n;)t+=n.offsetLeft,e+=n.offsetTop,n=n.offsetParent;return{x:t,y:e}},this.size=function(){var t=this.set[0],n=t.getBoundingClientRect(),i={width:n.width,height:n.height};if(e.varg(arguments,0,!1)){var r=window.getComputedStyle(t,null);i.width+=r.getPropertyValue("margin-left")+r.getPropertyValue("margin-right"),i.height+=r.getPropertyValue("margin-top")+r.getPropertyValue("margin-bottom"),"border-box"==r.getPropertyValue("box-sizing")&&(i.width+=r.getPropertyValue("padding-left")+r.getPropertyValue("padding-right"),i.height+=r.getPropertyValue("padding-top")+r.getPropertyValue("padding-bottom"))}return i}}function i(t,n){var i=this;this.host=t,this.property=n,this.fns={callback:e.fn.eatCall},this._processChange=function(t){i.fns.callback(t)},this._createListener=function(t,n){var i=n;return{get:function(){return i},set:function(n){e.iter(t,function(t){t(n)}),i=n}}},this.changed=function(t){return this.fns.callback=t,this},this.onto=function(t){return new function(t,n){var i=this;this.parent=t,this.element=n,this.started=!1,this.fns={reset:e.fn.eatCall,transform:e.fn.identity,placement:function(t,e){e.html(t)}},this._applyChange=function(t){i.started||(i.fns.reset(t,i.element),i.started=!0),i.fns.placement(i.fns.transform(t),i.element)},this.reset=function(t){return this.fns.reset=t,this},this.transform=function(t){return this.fns.transform=t,this},this.placement=function(t){return this.fns.placement=t,this},this.and=function(){return t.changed(this._applyChange),this.parent}}(this,t)},this.begin=function(){if(e.prop(this.host,"__bindings__")||(this.host.__bindings__={}),!e.prop(this.host.__bindings__,n)){this.host.__bindings__[n]=[];var t=this._createListener(this.host.__bindings__[n],this.host[n]);Object.defineProperty(this.host,n,t)}return this.host.__bindings__[n].push(this._processChange),this._processChange(this.host[n]),this}}function r(t){var n=this;this.ary=t,this.fns={added:e.fn.eatCall,removed:e.fn.eatCall,changed:e.fn.eatCall},this._createListener=function(t,e){var i=e;return{get:function(){return i},set:function(e){n.fns.changed(e,t),i=e},configurable:!0}},this._wrapIndicies=function(){e.iter(this.ary,function(t,e){var i=n._createListener(e,t);Object.defineProperty(n.ary,e+"",i)})},this.added=function(t){return this.fns.added=t,this},this.removed=function(t){return this.fns.removed=t,this},this.changed=function(t){return this.fns.changed=t,this},this.onto=function(t){return new function(t,n){var i=this;this.parent=t,this.element=n,this.consts={tag:"div"},this.fns={removal:function(t,e,n){e.remove()},transform:e.fn.identity,placement:function(t,e,n){e.html(t)}},this.tag=function(t){return this.consts.tag=t,this},this._applyAdd=function(t,n){var r=e.tag(i.consts.tag);i.fns.placement(i.fns.transform(t),r,n),i.element.append(r)},this._applyRemove=function(t,e){var n=i.element.children(!1).ith(e);i.fns.removal(t,n,e)},this._applyChanged=function(t,e){var n=i.element.children(!1).ith(e);i.fns.placement(i.fns.transform(t),n,e)},this.removal=function(t){return this.fns.removal=t,this},this.transform=function(t){return this.fns.transform=t,this},this.placement=function(t){return this.fns.placement=t,this},this.and=function(){return t.changed(this._applyChanged),t.removed(this._applyRemove),t.added(this._applyAdd),this.parent}}(this,t)},this.begin=function(){var t=this.ary.push;this.ary.push=function(){for(var e=0;e<arguments.length;e++)n.fns.added(arguments[e],n.ary.length+e);var i=t.apply(n.ary,arguments);return n._wrapIndicies(),i};var e=this.ary.push;this.ary.pop=function(){var t=n.ary.length-1;n.fns.removed(n.ary[t],t);var i=e.apply(n.ary);return n._wrapIndicies(),i};var i=this.ary.splice;this.ary.splice=function(t,e){for(var r=0;r<e;r++){var s=r+t;n.fns.removed(n.ary[s],s)}var o=i.apply(n.ary,[t,e]);return n._wrapIndicies(),o};for(var r=0;r<this.ary.length;r++)n.fns.added(this.ary[r],r);return n._wrapIndicies(),this}}return e.initFunctions=[],e.fn={eatCall:function(){},identity:function(t){return t},contradiction:function(){return!1},tautology:function(){return!0},resign:function(t){return-t},negation:function(t){return!t}},e.config={debug:!1,documentRoot:document,callbacks:{preInsert:e.fn.eatCall,preRequest:e.fn.eatCall}},arguments.length>0&&function t(e,n){for(var i in e)"object"==typeof n[i]?t(e[i],n[i]):void 0!==e[i]&&(n[i]=e[i])}(e.config,arguments[0]),e.varg=function(t,e,n){return t.length>e?t[e]:n},e.varg.on=function(t){return function(n,i){return e.varg(t,n,i)}},e.prop=function(n,i){var r=e.varg(arguments,2,t),s=n.hasOwnProperty(i);return r===t?s:s?n[i]:r},e.prop.on=function(n){return function(i){e.prop.apply(this,[n,i,e.varg(arguments,1,t)])}},e.extends=function(t,e){var n=[].slice.call(arguments);n.splice(0,2),n=[t].concat(n),e.apply(t,n)},e.functionName=function(t){var e=/^function\s+([\w\$]+)\s*\(/.exec(t.toString());return e?e[1]:"<anonymous function>"},e.typeCheck=function(t){for(var n=1;n<arguments.length;n++){var i=arguments[n];if(null===i){if(null===t)return n-1}else{if(typeof t==i)return n-1;try{if(t instanceof i)return n-1}catch(t){}}}var r=[];for(n=1;n<arguments.length;n++){var s=arguments[n];null==s?r.push("null"):"string"==typeof s?r.push(s):r.push(e.functionName(s))}throw"Incorrect parameter type: "+typeof t+" (expected one of "+r.join(", ")+")"},e.resolve=function(t){if("function"!=typeof t)return t;var e=[].slice.call(arguments);return e.splice(0,1),t.apply(null,e)},e.log=function(){e.config.debug&&console.log.apply(null,arguments)},e.time=function(){new Date;return data.getTime()},e.range=function(t){var e=0;t=t;arguments.length>1&&(e=arg,t=arguments[1]);for(var n=[],i=e;i<t;i++)n.push(i);return n},e.tag=function(t){var i=new n(document.createElement(t)),r=e.varg.on(arguments),s=r(1,null),o=r(2,"");return i.classify(s).html(o)},e.iter=function(t,n){switch(e.typeCheck(t,Array,"object")){case 0:for(var i=0;i<t.length;i++)n(t[i],i);break;case 1:for(var r in t)n(r,t[r])}},e.comprehension=function(t,e){for(var n=[],i=0;i<t.length;i++){var r=e(t[i],i);void 0!==r&&n.push(r)}return n},e.defer=function(t,e){setTimeout(t,e)},e.init=function(t){e.initFunctions.push(t)},/complete|loaded|interactive/.test(document.readyState)?e.iter(e.initFunctions,function(t){t()}):window&&window.addEventListener("DOMContentLoaded",function(){e.iter(e.initFunctions,function(t){t()})}),e.request=function(t,n){return new function(t,n){this.fns={success:e.fn.eatCall,failure:e.fn.eatCall},this.url=n,this.method=t,this.query={},this.body=null,this.mimetype="text/plain",this.success=function(t){return this.fns.success=t,this},this.failure=function(t){return this.fns.failure=t,this},this.json=function(t){return this.mimetype="application/json",this.body=t,this},this.query=function(t){return this.query=t,this},this._processResponse=function(t){var n=t.getResponseHeader("Content-Type"),i=t.status,r=null;switch(n){case"application/json":r=JSON.parse(t.responseText);default:throw"Unknown response content type ("+n+")"}e.log("Received "+i+" ("+this.method+", "+this.url+"):",r),(i<400?this.fns.success:this.fns.failure)(r,i)},this.send=function(i){var r=new XMLHttpRequest;e.config.callbacks.preRequest(this,r);var s=this.url,o=[];e.iter(this.query,function(t,e){o.push(t+"="+encodeURIComponent(e))}),o.length>0&&(s+="?"+o.join("&"));var a=this;r.onreadystatechange=function(){a._processResponse(this)};var c="";if(null!=this.body){switch(this.mimetype){case"application/json":c=JSON.stringify(this.body);default:throw"Unknown request content type ("+this.mimetype+")"}r.setRequestHeader("Content-Type",this.mimetype)}r.open(this.method,s,!0),r.send(c),e.log("Sent ("+t+": "+n+")",this.body)}}(t,n)},e.binding=function(t){return t instanceof Array?new r(t):new i(t,e.varg(arguments,1))},e.arrayBinding=function(t){return new r(t)},e}